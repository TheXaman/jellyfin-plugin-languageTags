<!DOCTYPE html>
<html>
    <head>
        <title>Language Tags</title>
    </head>
    <body>
        <div data-role="page" class="page type-interior pluginConfigurationPage tbsConfigurationPage" data-require="emby-input,emby-button">
            <div data-role="content">
                <div class="content-primary">
                    <form class="tbsConfigurationPage">
                        <div class="sectionTitleContainer flex align-items-center">
                            <h2 class="sectionTitle">Language Tags</h2>
                            <a is="emby-linkbutton" class="raised button-alt headerHelpButton emby-button" target="_blank" href="https://github.com/TheXaman/jellyfin-plugin-languageTags">Help</a>
                        </div>
                        <div class="verticalSection">
                            <p>This plugin scans your movies, tv shows and collections for the available audio tracks and adds language tags to the items.</p>
                            <p>Additionally the plugin can add subtitle language tags, if enabled.</p>
                        </div>
                        <hr />
                        <div class="verticalSection">
                            <h3>Whitelist Language Tags (Optional!)</h3>
                            <h4>Leave empty to allow all languages, or select specific languages below.</h4>

                            <div class="fieldDescription" style="margin-bottom: 15px;">
                                <p>Only selected languages will be added to your media. If no languages are selected, all detected languages will be added.</p>
                            </div>

                            <!-- Common Languages Section -->
                            <div style="margin-bottom: 20px;">
                                <h4>Common Languages</h4>
                                <div id="common-languages-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Search Section -->
                            <div style="margin-bottom: 20px;">
                                <h4>Search All Languages</h4>
                                <input type="text" id="language-search" placeholder="Type to search languages..." style="width: 100%; margin-bottom: 10px;" />
                                <div id="language-search-results" style="max-height: 300px; overflow-y: auto; border: 1px solid #444; border-radius: 4px; padding: 10px; display: none;">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Selected Languages Display -->
                            <div style="margin-bottom: 20px;">
                                <h4>Selected Languages (<span id="selected-count">0</span>)</h4>
                                <div id="selected-languages-chips" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 40px; padding: 10px; border: 1px solid #444; border-radius: 4px; background: rgba(0,0,0,0.2);">
                                    <span style="color: #888;">No languages selected (all languages allowed)</span>
                                </div>
                            </div>

                            <!-- Hidden input for form submission -->
                            <input type="hidden" id="whitelist-language-tags" name="whitelist-language-tags" />
                        </div>
                        <hr />
                        <div class="verticalSection">
                            <h3>Custom Tag Prefixes</h3>
                            <label for="audio-language-tag-prefix">Audio Language Tag Prefix:</label>
                            <input type="text" id="audio-language-tag-prefix" name="audio-language-tag-prefix" placeholder="language_" />
                            <div class="fieldDescription">
                                <p>Customize the prefix for audio language tags. Default is "language_". Tags will be created as "[prefix][language_name]", e.g., "language_English", "language_German".</p>
                                <p><strong>Leave empty to use default.</strong> If specified, must be at least 3 characters and different from subtitle prefix.</p>
                            </div>
                            <label for="subtitle-language-tag-prefix">Subtitle Language Tag Prefix:</label>
                            <input type="text" id="subtitle-language-tag-prefix" name="subtitle-language-tag-prefix" placeholder="subtitle_language_" />
                            <div class="fieldDescription">
                                <p>Customize the prefix for subtitle language tags. Default is "subtitle_language_". Tags will be created as "[prefix][language_name]", e.g., "subtitle_language_English", "subtitle_language_French".</p>
                                <p><strong>Leave empty to use default.</strong> If specified, must be at least 3 characters and different from audio prefix.</p>
                            </div>
                        </div>
                        <hr />
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <h3>Subtitle Language Tags</h3>
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="subtitle-tags" name="subtitle-tags" />
                                <span>Extract subtitle language tags</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">
                                <p>When enabled, the plugin will add subtitle language tags e.g. "subtitle_language_French" based on the available subtitles.</p>
                            </div>
                        </div>
                        <hr />
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <h3>Undefined Language Tags</h3>
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="disable-undefined-tags" name="disable-undefined-tags" />
                                <span>Disable undefined language tags</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">
                                <p>When enabled, the plugin will NOT add "language_Undetermined" tags for content where no language information can be determined. This is disabled by default (undefined tags are added).</p>
                            </div>
                        </div>
                        <hr />
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <h3>Full Refresh Options</h3>
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="always-force-full-refresh" name="always-force-full-refresh" />
                                <span>Always full refresh</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">
                                <p>When enabled, the plugin will always perform a full refresh of the library when scanning for language tags. This is resource intensive and should only be enabled if you are experiencing issues with the plugin.</p>
                            </div>
                        </div>
                        <div>
                            <button is="emby-button" type="button" class="raised block" id="refresh-movies"><span>Force full refresh for Movies</span></button>
                            <button is="emby-button" type="button" class="raised block" id="refresh-tvshows"><span>Force full refresh for TV Shows</span></button>
                            <button is="emby-button" type="button" class="raised block" id="refresh-collections"><span>Force full refresh for Collections</span></button>
                            <button is="emby-button" type="button" class="raised block" id="refresh-external-subtitles"><span>Force full refresh for EXTERNAL Subtitles</span></button>
                            <button is="emby-button" type="button" class="raised block" id="refresh-everything"><span>Force full refresh for Everything</span></button>
                        </div>
                        <hr />
                        <div>
                            <h3>WARNING Remove All Language Tags</h3>
                            <button is="emby-button" type="button" class="raised block emby-button-cancel" id="remove-all-tags"><span>Remove ALL language tags from Everything</span></button>
                        </div>
                        <hr />
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <h3>Synchronous Refresh Option</h3>
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="synchronous-refresh" name="synchronous-refresh" />
                                <span>Synchronous refresh</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">
                                <p>NOT RECOMMENDED</p>
                                <p>When enabled, the plugin will perform a synchronous refresh of the library when scanning for language tags. This takes significantly longer, but is less ressource intensive.</p>
                                <p>Usefull for low powered setup like a Raspberry Pi.</p>
                            </div>
                        </div>
                        <br />
                        <button is="emby-button" type="submit" class="raised button-submit block"><span>${Save}</span></button>
                    </form>
                </div>
            </div>
            <script type="text/javascript">
                var pluginId = "e6ee25c2-d12c-4382-a48c-66ee9c1c33cb";

                // Language database with ISO codes and names
                var allLanguages = [
                    { name: "English", iso: ["eng", "en"] },
                    { name: "Spanish", iso: ["spa", "es"] },
                    { name: "French", iso: ["fre", "fra", "fr"] },
                    { name: "German", iso: ["ger", "deu", "de"] },
                    { name: "Italian", iso: ["ita", "it"] },
                    { name: "Portuguese", iso: ["por", "pt"] },
                    { name: "Russian", iso: ["rus", "ru"] },
                    { name: "Japanese", iso: ["jpn", "ja"] },
                    { name: "Chinese", iso: ["chi", "zho", "zh"] },
                    { name: "Korean", iso: ["kor", "ko"] },
                    { name: "Arabic", iso: ["ara", "ar"] },
                    { name: "Hindi", iso: ["hin", "hi"] },
                    { name: "Dutch", iso: ["dut", "nld", "nl"] },
                    { name: "Polish", iso: ["pol", "pl"] },
                    { name: "Turkish", iso: ["tur", "tr"] },
                    { name: "Swedish", iso: ["swe", "sv"] },
                    { name: "Danish", iso: ["dan", "da"] },
                    { name: "Norwegian", iso: ["nor", "nb", "nn", "no"] },
                    { name: "Finnish", iso: ["fin", "fi"] },
                    { name: "Czech", iso: ["cze", "ces", "cs"] },
                    { name: "Greek", iso: ["gre", "ell", "el"] },
                    { name: "Hebrew", iso: ["heb", "he"] },
                    { name: "Hungarian", iso: ["hun", "hu"] },
                    { name: "Romanian", iso: ["rum", "ron", "ro"] },
                    { name: "Thai", iso: ["tha", "th"] },
                    { name: "Vietnamese", iso: ["vie", "vi"] },
                    { name: "Indonesian", iso: ["ind", "id"] },
                    { name: "Malay", iso: ["may", "msa", "ms"] },
                    { name: "Ukrainian", iso: ["ukr", "uk"] },
                    { name: "Croatian", iso: ["hrv", "hr"] },
                    { name: "Serbian", iso: ["srp", "sr"] },
                    { name: "Bulgarian", iso: ["bul", "bg"] },
                    { name: "Slovak", iso: ["slo", "slk", "sk"] },
                    { name: "Catalan", iso: ["cat", "ca"] },
                    { name: "Bengali", iso: ["ben", "bn"] },
                    { name: "Persian", iso: ["per", "fas", "fa"] },
                    { name: "Tamil", iso: ["tam", "ta"] },
                    { name: "Telugu", iso: ["tel", "te"] },
                    { name: "Urdu", iso: ["urd", "ur"] },
                    { name: "Afrikaans", iso: ["afr", "af"] },
                    { name: "Albanian", iso: ["alb", "sqi", "sq"] },
                    { name: "Armenian", iso: ["arm", "hye", "hy"] },
                    { name: "Azerbaijani", iso: ["aze", "az"] },
                    { name: "Basque", iso: ["baq", "eus", "eu"] },
                    { name: "Belarusian", iso: ["bel", "be"] },
                    { name: "Bosnian", iso: ["bos", "bs"] },
                    { name: "Burmese", iso: ["bur", "mya", "my"] },
                    { name: "Esperanto", iso: ["epo", "eo"] },
                    { name: "Estonian", iso: ["est", "et"] },
                    { name: "Filipino", iso: ["fil"] },
                    { name: "Galician", iso: ["glg", "gl"] },
                    { name: "Georgian", iso: ["geo", "kat", "ka"] },
                    { name: "Gujarati", iso: ["guj", "gu"] },
                    { name: "Icelandic", iso: ["ice", "isl", "is"] },
                    { name: "Kannada", iso: ["kan", "kn"] },
                    { name: "Kazakh", iso: ["kaz", "kk"] },
                    { name: "Khmer", iso: ["khm", "km"] },
                    { name: "Lao", iso: ["lao", "lo"] },
                    { name: "Latvian", iso: ["lav", "lv"] },
                    { name: "Lithuanian", iso: ["lit", "lt"] },
                    { name: "Macedonian", iso: ["mac", "mkd", "mk"] },
                    { name: "Malayalam", iso: ["mal", "ml"] },
                    { name: "Marathi", iso: ["mar", "mr"] },
                    { name: "Mongolian", iso: ["mon", "mn"] },
                    { name: "Nepali", iso: ["nep", "ne"] },
                    { name: "Pashto", iso: ["pus", "ps"] },
                    { name: "Punjabi", iso: ["pan", "pa"] },
                    { name: "Sindhi", iso: ["snd", "sd"] },
                    { name: "Sinhala", iso: ["sin", "si"] },
                    { name: "Slovenian", iso: ["slv", "sl"] },
                    { name: "Swahili", iso: ["swa", "sw"] },
                    { name: "Tagalog", iso: ["tgl", "tl"] },
                    { name: "Tajik", iso: ["tgk", "tg"] },
                    { name: "Uzbek", iso: ["uzb", "uz"] },
                    { name: "Welsh", iso: ["wel", "cym", "cy"] },
                    { name: "Yiddish", iso: ["yid", "yi"] },
                    { name: "Undetermined", iso: ["und"] },
                    { name: "Silent", iso: ["zxx"]}
                ];

                // Top 20 most common languages for quick access
                var commonLanguages = [
                    "English", "Spanish", "French", "German", "Italian",
                    "Portuguese", "Russian", "Japanese", "Chinese", "Korean",
                    "Arabic", "Hindi", "Dutch", "Polish", "Turkish",
                    "Swedish", "Danish", "Norwegian", "Finnish", "Czech"
                ];

                var selectedLanguages = new Set();

                function initializeLanguageSelector() {
                    // Populate common languages grid
                    var commonGrid = document.getElementById("common-languages-grid");
                    commonGrid.innerHTML = "";

                    commonLanguages.forEach(function(langName) {
                        var lang = allLanguages.find(function(l) { return l.name === langName; });
                        if (lang) {
                            var checkbox = document.createElement("label");
                            checkbox.style.cssText = "display: flex; align-items: center; cursor: pointer; padding: 5px;";
                            checkbox.innerHTML = '<input type="checkbox" class="language-checkbox" data-language="' + lang.name + '" style="margin-right: 8px;"> <span>' + lang.name + '</span>';
                            commonGrid.appendChild(checkbox);
                        }
                    });

                    // Setup search functionality
                    var searchInput = document.getElementById("language-search");
                    var searchResults = document.getElementById("language-search-results");

                    searchInput.addEventListener("input", function() {
                        var query = this.value.toLowerCase().trim();

                        if (query.length < 2) {
                            searchResults.style.display = "none";
                            return;
                        }

                        var matches = allLanguages.filter(function(lang) {
                            return lang.name.toLowerCase().includes(query) ||
                                   lang.iso.some(function(code) { return code.toLowerCase().includes(query); });
                        });

                        if (matches.length > 0) {
                            searchResults.innerHTML = "";
                            matches.forEach(function(lang) {
                                var item = document.createElement("label");
                                item.style.cssText = "display: flex; align-items: center; cursor: pointer; padding: 8px; border-bottom: 1px solid #333;";
                                item.innerHTML = '<input type="checkbox" class="language-checkbox" data-language="' + lang.name + '" style="margin-right: 8px;"> <span>' + lang.name + ' <span style="color: #888; font-size: 0.9em;">(' + lang.iso.join(', ') + ')</span></span>';
                                searchResults.appendChild(item);
                            });
                            searchResults.style.display = "block";
                            attachCheckboxListeners();
                        } else {
                            searchResults.innerHTML = '<div style="padding: 10px; color: #888;">No languages found</div>';
                            searchResults.style.display = "block";
                        }
                    });

                    attachCheckboxListeners();
                }

                function attachCheckboxListeners() {
                    document.querySelectorAll(".language-checkbox").forEach(function(checkbox) {
                        checkbox.addEventListener("change", function() {
                            var langName = this.getAttribute("data-language");
                            if (this.checked) {
                                selectedLanguages.add(langName);
                            } else {
                                selectedLanguages.delete(langName);
                            }
                            updateSelectedDisplay();
                            syncCheckboxes(langName);
                        });
                    });
                }

                function syncCheckboxes(langName) {
                    document.querySelectorAll('.language-checkbox[data-language="' + langName + '"]').forEach(function(checkbox) {
                        checkbox.checked = selectedLanguages.has(langName);
                    });
                }

                function updateSelectedDisplay() {
                    var chipsContainer = document.getElementById("selected-languages-chips");
                    var countSpan = document.getElementById("selected-count");

                    countSpan.textContent = selectedLanguages.size;

                    if (selectedLanguages.size === 0) {
                        chipsContainer.innerHTML = '<span style="color: #888;">No languages selected (all languages allowed)</span>';
                    } else {
                        chipsContainer.innerHTML = "";
                        Array.from(selectedLanguages).sort().forEach(function(langName) {
                            var chip = document.createElement("div");
                            chip.style.cssText = "display: inline-flex; align-items: center; background: #2196F3; color: white; padding: 5px 10px; border-radius: 16px; font-size: 0.9em;";
                            chip.innerHTML = langName + ' <button type="button" style="background: none; border: none; color: white; margin-left: 8px; cursor: pointer; font-size: 1.2em; padding: 0; line-height: 1;">&times;</button>';

                            chip.querySelector("button").addEventListener("click", function() {
                                selectedLanguages.delete(langName);
                                updateSelectedDisplay();
                                syncCheckboxes(langName);
                            });

                            chipsContainer.appendChild(chip);
                        });
                    }

                    // Update hidden input with ISO codes
                    updateHiddenInput();
                }

                function updateHiddenInput() {
                    var isoCodes = [];
                    selectedLanguages.forEach(function(langName) {
                        var lang = allLanguages.find(function(l) { return l.name === langName; });
                        if (lang) {
                            // Only save 3-letter ISO codes (filter out 2-letter codes)
                            var threeLetterCodes = lang.iso.filter(function(code) { return code.length === 3; });
                            isoCodes = isoCodes.concat(threeLetterCodes);
                        }
                    });
                    document.getElementById("whitelist-language-tags").value = isoCodes.join(", ");
                }

                function loadSelectedLanguages(isoCodesString) {
                    selectedLanguages.clear();

                    if (!isoCodesString || isoCodesString.trim() === "") {
                        updateSelectedDisplay();
                        return;
                    }

                    var isoCodes = isoCodesString.split(",").map(function(code) { return code.trim().toLowerCase(); });

                    allLanguages.forEach(function(lang) {
                        var hasMatch = lang.iso.some(function(code) {
                            return isoCodes.includes(code.toLowerCase());
                        });
                        if (hasMatch) {
                            selectedLanguages.add(lang.name);
                        }
                    });

                    updateSelectedDisplay();
                    syncAllCheckboxes();
                }

                function syncAllCheckboxes() {
                    document.querySelectorAll(".language-checkbox").forEach(function(checkbox) {
                        var langName = checkbox.getAttribute("data-language");
                        checkbox.checked = selectedLanguages.has(langName);
                    });
                }

                $(".tbsConfigurationPage").on("pageshow", function () {
                    Dashboard.showLoadingMsg();
                    var page = this;

                    // Initialize language selector
                    initializeLanguageSelector();

                    ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                        document.getElementById("always-force-full-refresh").checked = config.AlwaysForceFullRefresh;
                        document.getElementById("synchronous-refresh").checked = config.SynchronousRefresh;
                        document.getElementById("subtitle-tags").checked = config.AddSubtitleTags;
                        document.getElementById("disable-undefined-tags").checked = config.DisableUndefinedLanguageTags;
                        document.getElementById("audio-language-tag-prefix").value = config.AudioLanguageTagPrefix || "";
                        document.getElementById("subtitle-language-tag-prefix").value = config.SubtitleLanguageTagPrefix || "";

                        // Load selected languages from config
                        loadSelectedLanguages(config.WhitelistLanguageTags || "");

                        Dashboard.hideLoadingMsg();
                    });
                });

                $(".tbsConfigurationPage").on("submit", function () {
                    Dashboard.showLoadingMsg();

                    ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                        var audioPrefix = document.getElementById("audio-language-tag-prefix").value.trim();
                        var subtitlePrefix = document.getElementById("subtitle-language-tag-prefix").value.trim();

                        // Validate prefixes only if they're not empty (empty = use server defaults)
                        var validationError = null;
                        if (audioPrefix !== "" && audioPrefix.length < 3) {
                            validationError = "Audio language tag prefix must be at least 3 characters long (or leave empty for default).";
                        } else if (subtitlePrefix !== "" && subtitlePrefix.length < 3) {
                            validationError = "Subtitle language tag prefix must be at least 3 characters long (or leave empty for default).";
                        } else if (audioPrefix !== "" && subtitlePrefix !== "" && audioPrefix.toLowerCase() === subtitlePrefix.toLowerCase()) {
                            validationError = "Audio and subtitle prefixes must be different.";
                        }

                        if (validationError) {
                            Dashboard.hideLoadingMsg();
                            Dashboard.alert(validationError);
                            return false;
                        }

                        config.AlwaysForceFullRefresh = document.getElementById("always-force-full-refresh").checked;
                        config.WhitelistLanguageTags = document.getElementById("whitelist-language-tags").value;
                        config.SynchronousRefresh = document.getElementById("synchronous-refresh").checked;
                        config.AddSubtitleTags = document.getElementById("subtitle-tags").checked;
                        config.DisableUndefinedLanguageTags = document.getElementById("disable-undefined-tags").checked;
                        config.AudioLanguageTagPrefix = audioPrefix;
                        config.SubtitleLanguageTagPrefix = subtitlePrefix;

                        ApiClient.updatePluginConfiguration(pluginId, config).then(Dashboard.processPluginConfigurationUpdateResult);
                    });

                    return false;
                });

                $("#refresh-movies").on("click", function () {
                    var request = {
                        url: ApiClient.getUrl("LanguageTags/RefreshLanguageTags?type=movies"),
                        type: "POST",
                    };

                    ApiClient.fetch(request)
                        .then(function () {
                            Dashboard.alert("Full language tag refresh for movies queued");
                        })
                        .catch(function () {
                            Dashboard.alert({
                                message: "Unexpected error occurred!",
                            });
                        });
                });

                $("#refresh-tvshows").on("click", function () {
                    var request = {
                        url: ApiClient.getUrl("LanguageTags/RefreshLanguageTags?type=tvshows"),
                        type: "POST",
                    };

                    ApiClient.fetch(request)
                        .then(function () {
                            Dashboard.alert("Full language tag refresh for TV shows queued");
                        })
                        .catch(function () {
                            Dashboard.alert({
                                message: "Unexpected error occurred!",
                            });
                        });
                });

                $("#refresh-collections").on("click", function () {
                    var request = {
                        url: ApiClient.getUrl("LanguageTags/RefreshLanguageTags?type=collections"),
                        type: "POST",
                    };

                    ApiClient.fetch(request)
                        .then(function () {
                            Dashboard.alert("Full language tag refresh for collections queued");
                        })
                        .catch(function () {
                            Dashboard.alert({
                                message: "Unexpected error occurred!",
                            });
                        });
                });

                $("#refresh-external-subtitles").on("click", function () {
                    var request = {
                        url: ApiClient.getUrl("LanguageTags/RefreshLanguageTags?type=externalsubtitles"),
                        type: "POST",
                    };

                    ApiClient.fetch(request)
                        .then(function () {
                            Dashboard.alert("Full external subtitle language tag refresh queued");
                        })
                        .catch(function () {
                            Dashboard.alert({
                                message: "Unexpected error occurred!",
                            });
                        });
                });

                $("#refresh-everything").on("click", function () {
                    var request = {
                        url: ApiClient.getUrl("LanguageTags/RefreshLanguageTags?type=everything"),
                        type: "POST",
                    };

                    ApiClient.fetch(request)
                        .then(function () {
                            Dashboard.alert("Full language tag refresh for everything queued");
                        })
                        .catch(function () {
                            Dashboard.alert({
                                message: "Unexpected error occurred!",
                            });
                        });
                });

                $("#remove-all-tags").on("click", function () {
                    var request = {
                        url: ApiClient.getUrl("LanguageTags/RemoveAllLanguageTags"),
                        type: "POST",
                    };

                    ApiClient.fetch(request)
                        .then(function () {
                            Dashboard.alert("Removal of all language tags queued");
                        })
                        .catch(function () {
                            Dashboard.alert({
                                message: "Unexpected error occurred!",
                            });
                        });
                });
            </script>
        </div>
    </body>
</html>
